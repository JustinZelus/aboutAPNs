## 语音播报趟坑记录

近期项目需求，做一个语音播报功能。根据后台的推送，向用于语音播报信息。类似支付宝、微信、收钱吧的收款到账语音提醒。

最终方案，主要参考了[这篇文章](https://blog.csdn.net/weixin_33801856/article/details/86797887)

### 语音合成

#### 苹果原生方案
采用`AVFoundation`中的`AVSpeechSynthesizer`。实现比较简单，但效果不是很好，听起来比较机械化

#### 百度语音
听起来比较自然，最终选择方案

#### 录制音频片段
将一段语音分成若干部分，合成后播放或者顺序播放

### 后台推送播放
在前台时候我们可以，在`UNUserNotificationCenter`的代理方法中

```
- (void)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(void (^)(UNNotificationPresentationOptions options))completionHandler
```
根据获取到的信息合成语音，再进行播放。

#### Notification Service Extension

而如果要监听后台收到推送的事件，只能通过应用扩展`Notification Service Extension`来实现。
#### iOS12.1后对推送扩展的限制
而iOS12.1之后苹果在应用推送扩展中，禁用了`AVAudioSession`，使得任何企图在扩展中播放声音的方案都无效了。百度语音在试图`active`AVAudioSession无果后，直接将`speak`改为`synthesize`只合成不播放。

#### 推送的声音只能是已存在音频
根据官方文档，`UNNotificationSound`所设置音频只能存在与两个位置，一个`mainBundle`里，另一个应用的`Library/Sounds`下。

值得注意的是应用扩展与宿主应用的文件目录是不同的，在应用扩展中，是无法操作应用的文件目录的。这时在应用扩展中动态合成或下载的方式行不通。

于是乎，要么将音频提前准备后拖到工程里。要么在推送到来之前，网络请求语音包，然后放到`Library/Sounds`下。

#### 在推送扩展中使用本地推送
在应用扩展中同样可以使用本地推送，那么在一个推送来临之时，便可以转化为多次本地推送，播放多次声音。于是乎，就可以将一段音频分为多段进行推送播放。

将音频拆分成多段之后，可以有效减少

缺点也很明显，它会带来额外的震动，分段越多震动次数越多。而且分段越小，要让整句衔接流畅自然，就更加困难。

#### 语音文件分片方案

##### 分成两片方案

语音分成两部分，开头部分类似`支付宝收款`的若干种语音消息。

第二部分，是金额部分。

金额部分，又可分两种方案

第一种，一百以内小数元+一千以内整数元+一千以内整数加余元+数千余元+数万余元

这种方案音频数据14M左右

第二种，一千以内小数+数千数万余元

这种方案音频文件45M+，纯OC简单项目，打包后40M左右。对于一个iOS项目还在可以接受的范围。

#### 如何获取语音文件

#### 分段过多后某段音频无法播放问题
如果分段是三段以上，发现某段音频推送到了但始终无法顺利播放。

推测是与推送时机有关系。于是反复调节推送间隔无果。

最后找到原因，本地推送的`Request`的`identifier`设置的是一样的，所以两个本地推送冲突了，只能播放一个。

#### 那到底推送时机有何影响
经过反复试验表明，推送时机并不会造成其他推送声音被打断。无论怎样设置推送间隔，所有推送的声音都可以完整的播放出来。

但是，间隔果断会导致声音重叠在一起，不利于辨认及收听。

经测试，间隔时间跟音频时长大致相当时，听起来比较自然。想`支付宝收款`、`微信收款`这样的语言开头大概1.3s左右。具体设置多少可以多试几次，让语音衔接得尽量自然些。

#### 音频文件末尾的空白
用百度语音生成的文件，末尾都有一大段留白。那么这部分留白，需不需要处理呢。

其一，音频间的衔接主要取决于推送间隔，与语音文件时长关系不大。
其二，音频有效时长后有些许留白会更为自然些。

所以，所生成语音文件末尾的留白，可以不予理会直接使用。